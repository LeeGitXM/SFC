<?xml version="1.0" ?>
<sfc zoom="1.0666667" canvas="13 22" execution-mode="Callable" version="7.9.0 (b2016101208)" timestamp="Wed Mar 29 00:19:35 CDT 2017" hot-editable="false" persist-state="false">
	<onstop>def onStop(chart):
	"""
	This will run once when the chart is stopped
	normally.

	Arguments:
		chart: A reference to the chart's scope.
	"""
</onstop>
	<oncancel>def onCancel(chart):
	"""
	This will run once if the chart is cancelled.

	Arguments:
		chart: A reference to the chart's scope.
	"""
</oncancel>
	<onabort>def onAbort(chart):
	"""
	This will run once if the chart is aborted.
	The exception that caused the abort is
	available via chart.abortCause

	Arguments:
		chart: A reference to the chart's scope.
	"""
</onabort>
	<step id="18f94b8a-85b4-11d9-a871-006008c66680" location="4 0" name="S88Begin_13746" factory-id="begin-step">
<parameters>
	<parameter key="true"><name>Name</name><expression>"Implement Cat-Out"</expression></parameter>
</parameters>
		<associated-data>{}</associated-data>
	</step>
	<step id="393002b0-6b48-11d9-a9ad-00022dc3c8fd" location="4 1" name="ShowQueue" factory-id="com.ils.showQueueStep"><name>ShowQueue</name><description></description><id>393002b0-6b48-11d9-a9ad-00022dc3c8fd</id>		<associated-data>{}</associated-data>
	</step>
	<step id="4acfc3e1-6b43-11d9-a9ad-00022dc3c8fd" location="4 2" name="Initialize" factory-id="com.ils.manualDataEntryStep"><manualDataConfig>{"rows":[{"key":"catout-download-complete.value","destination":"operation","prompt":"Signal to remove the UIL notification","units":"","defaultValue":false,"lowLimit":null,"highLimit":null},{"key":"oil-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"MAN","lowLimit":null,"highLimit":null},{"key":"oil-flow-op.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":-5.0,"lowLimit":null,"highLimit":null},{"key":"irg-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"MAN","lowLimit":null,"highLimit":null},{"key":"irg-flow-op.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":-5.0,"lowLimit":null,"highLimit":null},{"key":"d20-cast-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"MAN","lowLimit":null,"highLimit":null},{"key":"d20-cast-flow-op.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":-5.0,"lowLimit":null,"highLimit":null},{"key":"d20a-cast-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"MAN","lowLimit":null,"highLimit":null},{"key":"d20a-cast-flow-op.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":-5.0,"lowLimit":null,"highLimit":null},{"key":"d20b-cast-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"MAN","lowLimit":null,"highLimit":null},{"key":"d20b-cast-flow-op.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":-5.0,"lowLimit":null,"highLimit":null},{"key":"r1-c6-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"d20-return-h2o-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"d20a-return-h2o-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"d20b-return-h2o-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"r1-c2-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"r1-c2-flow-sp.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":-1,"lowLimit":null,"highLimit":null},{"key":"r2-c2-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"r2-c2-flow-sp.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":-0.9,"lowLimit":null,"highLimit":null},{"key":"r2-ss1-c3-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"r2-ss2-c3-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"r2-ss3-c3-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"r2-ss4-c3-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"r2-ss5-c3-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"r2-ss6-c3-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"r2-ss1-c6-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"r2-ss2-c6-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"r2-ss3-c6-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"r2-ss4-c6-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"r2-ss5-c6-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"r2-ss6-c6-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"vcl4-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"vcl4-flow-sp.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":0.0,"lowLimit":null,"highLimit":null},{"key":"e204-c3-level-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"MAN","lowLimit":null,"highLimit":null},{"key":"e204-c3-level-op.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":-5.0,"lowLimit":null,"highLimit":null},{"key":"e202-bypass-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"MAN","lowLimit":null,"highLimit":null},{"key":"e202-bypass-flow-op.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":80.0,"lowLimit":null,"highLimit":null},{"key":"e205-bypass-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"e205-bypass-flow-sp.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":45.0,"lowLimit":null,"highLimit":null},{"key":"e502-temp-mode.outputValue","destination":"operation","prompt":"RDW","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"e502-temp-sp.outputValue","destination":"operation","prompt":"RDW","units":"","defaultValue":45.0,"lowLimit":null,"highLimit":null},{"key":"vocl3-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"vocl3-flow-sp.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":0.0,"lowLimit":null,"highLimit":null},{"key":"alkyl-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"alkyl-flow-sp.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":0.0,"lowLimit":null,"highLimit":null},{"key":"nh3-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"nh3-flow-sp.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":0.0,"lowLimit":null,"highLimit":null},{"key":"nh3-sweep-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"nh3-sweep-flow-sp.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":800.0,"lowLimit":null,"highLimit":null},{"key":"etoh-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"etoh-flow-sp.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":0.0,"lowLimit":null,"highLimit":null},{"key":"r1-c9-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"r1-c9-flow-sp.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":-1.0,"lowLimit":null,"highLimit":null},{"key":"r1-c9-recycle-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"r1-c9-recycle-flow-sp.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":0.0,"lowLimit":null,"highLimit":null},{"key":"r2-c9-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"r2-c9-flow-sp.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":-1.0,"lowLimit":null,"highLimit":null},{"key":"h2-small-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"h2-small-flow-sp.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":-1.0,"lowLimit":null,"highLimit":null},{"key":"h2-large-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"MAN","lowLimit":null,"highLimit":null},{"key":"h2-large-flow-op.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":-5.0,"lowLimit":null,"highLimit":null},{"key":"r1-c3-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"r1-c3-flow-spcl.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":0.0,"lowLimit":null,"highLimit":null},{"key":"r2-c3-flow-mode.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"r2-c3-flow-spcl.outputValue","destination":"operation","prompt":"A","units":"","defaultValue":0.0,"lowLimit":null,"highLimit":null}]}</manualDataConfig><description></description><scale>1.0</scale><timeoutUnit>SEC</timeoutUnit><windowTitle></windowTitle><timeout>-1.0</timeout><buttonLabel></buttonLabel><name>Initialize</name><id>4acfc3e1-6b43-11d9-a9ad-00022dc3c8fd</id><position>topCenter</position><window>S88-MANUAL-DATA-ENTRY-TASK-DIALOG</window><requireAllInputs>true</requireAllInputs><autoMode>automatic</autoMode>		<associated-data>{}</associated-data>
	</step>
	<step id="4e948c59-a2d9-11d9-b116-00065b88c6c2" location="4 3" name="MiscFlowSetup" factory-id="action-step">
		<start-script>import system
from ils.sfc.gateway.api import s88Set, s88Get, getDatabaseName, getProviderName, getChartLogger
from ils.sfc.common.constants import LOCAL_SCOPE, SUPERIOR_SCOPE, PHASE_SCOPE, OPERATION_SCOPE, GLOBAL_SCOPE

def onStart(chart,block):
	provider = getProviderName(chart)
	log = getChartLogger(chart)
	log.tracef("Entering %s",block.get("name",""))

	# Set whether VOCl3 / VCl4 in use and should have mode/sp downloaded at catout. 
	val=s88Get(chart,block,"mw-van.value",GLOBAL_SCOPE)
	if val &lt; 185.0:
		# VOCL3
		log.tracef("Setting download flags for VOCL3")
		s88Set(chart,block,"VCL4-FLOW-SP.DOWNLOAD",False,OPERATION_SCOPE)
		s88Set(chart,block,"VCL4-FLOW-MODE.DOWNLOAD",False,OPERATION_SCOPE)
		s88Set(chart,block,"VOCL3-FLOW-SP.DOWNLOAD",True,OPERATION_SCOPE)
		s88Set(chart,block,"VOCL3-FLOW-MODE.DOWNLOAD",True,OPERATION_SCOPE)
	else:
		# VCL4
		log.tracef("Setting download flags for VCL4")
		s88Set(chart,block,"VCL4-FLOW-SP.DOWNLOAD",True,OPERATION_SCOPE)
		s88Set(chart,block,"VCL4-FLOW-MODE.DOWNLOAD",True,OPERATION_SCOPE)
		s88Set(chart,block,"VOCL3-FLOW-SP.DOWNLOAD",False,OPERATION_SCOPE)
		s88Set(chart,block,"VOCL3-FLOW-MODE.DOWNLOAD",False,OPERATION_SCOPE)

	# Set whether oil in use and should have mode/sp downloaded at catout. 
	val=s88Get(chart,block,"oil-flag.value",GLOBAL_SCOPE)
	if not(val):
		# No oil in use
		log.tracef("Setting download flags for NO oil")
		s88Set(chart,block,"OIL-FLOW-MODE.DOWNLOAD",False,OPERATION_SCOPE)
		s88Set(chart,block,"OIL-FLOW-OP.DOWNLOAD",False,OPERATION_SCOPE)
	else:
		# Oil in use 
		log.tracef("Setting download flags for oil")
		s88Set(chart,block,"OIL-FLOW-MODE.DOWNLOAD",True,OPERATION_SCOPE)
		s88Set(chart,block,"OIL-FLOW-OP.DOWNLOAD",True,OPERATION_SCOPE)

	# Set whether ETOH in use and should have mode/sp downloaded at catout. 
	val=s88Get(chart,block,"etoh-flag.value",GLOBAL_SCOPE)
	if not(val):
		# No ETOH in use
		log.tracef("Setting download flags for NO ETOH")
		s88Set(chart,block,"ETOH-FLOW-MODE.DOWNLOAD",False,OPERATION_SCOPE)
		s88Set(chart,block,"ETOH-FLOW-SP.DOWNLOAD",False,OPERATION_SCOPE)
	else:
		# ETOH in use
		log.tracef("Setting download flags for ETOH")
		s88Set(chart,block,"ETOH-FLOW-MODE.DOWNLOAD",True,OPERATION_SCOPE)
		s88Set(chart,block,"ETOH-FLOW-SP.DOWNLOAD",True,OPERATION_SCOPE)

	# Set whether H2 and NH3 in use and should have mode/sp downloaded at catout. 
	qv = system.tag.read("[%s]SFC IO/Cold Stick Permissives/S88-RX-RCP-H2-FLAG" % (provider))
	if not (qv.quality.isGood()):
		log.warnf("H2 use flag tag quality is bad.  Values will be set to default of TRUE.")
		h2Flag = True
	else:
		h2flag = qv.value &gt; 0.5

	qv = system.tag.read("[%s]SFC IO/Cold Stick Permissives/S88-RX-RCP-NH3-FLAG" % (provider))
	if not (qv.quality.isGood()):
		log.warnf("NH3 use flag tag quality is bad.  Values will be set to default of TRUE.")
		nh3Flag = True
	else:
		nh3Flag = qv.value &gt; 0.5

	if not(h2Flag):
		# No H2 in use
		s88Set(chart,block,"H2-LARGE-FLOW-MODE.DOWNLOAD",False,OPERATION_SCOPE)
		s88Set(chart,block,"H2-LARGE-FLOW-OP.DOWNLOAD",False,OPERATION_SCOPE)
		s88Set(chart,block,"H2-SMALL-FLOW-MODE.DOWNLOAD",False,OPERATION_SCOPE)
		s88Set(chart,block,"H2-SMALL-FLOW-SP.DOWNLOAD",False,OPERATION_SCOPE)
	else:
		# H2 in use
		s88Set(chart,block,"H2-LARGE-FLOW-MODE.DOWNLOAD",True,OPERATION_SCOPE)
		s88Set(chart,block,"H2-LARGE-FLOW-OP.DOWNLOAD",True,OPERATION_SCOPE)
		s88Set(chart,block,"H2-SMALL-FLOW-MODE.DOWNLOAD",True,OPERATION_SCOPE)
		s88Set(chart,block,"H2-SMALL-FLOW-SP.DOWNLOAD",True,OPERATION_SCOPE)

	if not(nh3Flag):
		# No NH3 in use
		s88Set(chart,block,"NH3-FLOW-MODE.DOWNLOAD",False,OPERATION_SCOPE)
		s88Set(chart,block,"NH3-FLOW-SP.DOWNLOAD",False,OPERATION_SCOPE)
	else:
		# NH3 in use
		s88Set(chart,block,"NH3-FLOW-MODE.DOWNLOAD",True,OPERATION_SCOPE)
		s88Set(chart,block,"NH3-FLOW-SP.DOWNLOAD",True,OPERATION_SCOPE)

	log.tracef("%s has completed!",block.get("name",""))</start-script>
		<associated-data>{}</associated-data>
	</step>
	<step id="89afb1f8-6217-11dc-89a1-00142223a71b" location="4 4" name="SetupCaStRemoval" factory-id="action-step">
		<start-script>'''
  Determine the average D116 Poly Rate for the 20 minutes prior to Cat-Out, then set a 
  "Tgt-CaSt-Out-Poly-Rate" as some fraction of the "Avg-D116-Poly-Rate", which will be used by 
  a PV Monitoring Block to determine when CaSt addition is cut out afer a Cat-Out.
'''

import system
from ils.sfc.gateway.api import s88Set, s88Get, getDatabaseName, getProviderName, getChartLogger
from ils.sfc.common.constants import LOCAL_SCOPE, SUPERIOR_SCOPE, PHASE_SCOPE, OPERATION_SCOPE, GLOBAL_SCOPE

def onStart(chart,block):
	provider = "XOMhistory"
	log = getChartLogger(chart)
	log.tracef("Entering %s",block.get("name",""))

	fractPolyRateForCatout = 50.0
	
	# This tag needs to have history collected
	tagPath = "[%s]SFC IO/CatOut General/VDF060Z/value" % (provider)
	ds = system.tag.queryTagHistory(paths=[tagPath], aggregationMode='Average', returnSize=1, endDate=system.date.now(), rangeMinutes=-20.0)
	if ds.rowCount &lt;&gt; 1:
		log.errorf("Tag hostory query of %s did not return any data" % (tagPath))
		return
		
	avgD116PolyRate=ds.getValueAt(0, 1)
	log.infof("The average D116 poly rate is: %s", str(avgD116PolyRate))
	print "The average D116 poly rate is: %s", str(avgD116PolyRate)
	
	fractPolyRateForCatout = s88Get(chart,block,"co-frac-d116-poly-rate-for-cast-out.value",OPERATION_SCOPE)
	tgtCastOutPolyRate = avgD116PolyRate * fractPolyRateForCatout / 100.0

	log.tracef("   Fract-Poly-Rate-for-Catout = %s",str(fractPolyRateForCatout))	
	log.tracef("   Tgt-CaSt-Out-Poly-Rate = %s",str(tgtCastOutPolyRate))

	s88Set(chart,block,"co-avg-d116-poly-rate.value",avgD116PolyRate,OPERATION_SCOPE)
	s88Set(chart,block,"co-tgt-d116-poly-rate-for-cast-out.value",tgtCastOutPolyRate,OPERATION_SCOPE)

	log.tracef("   %s has completed!",block.get("name",""))
	
	print "...finished!"</start-script>
		<associated-data>{}</associated-data>
	</step>
	<step id="92d8e3d7-d2fe-4f1d-8f90-bcee848a1b88" location="4 11" name="DeleteNotification" factory-id="com.ils.deleteDelayNotification"><name>DeleteNotification</name><description></description><id>92d8e3d7-d2fe-4f1d-8f90-bcee848a1b88</id>		<associated-data>{}</associated-data>
	</step>
	<step id="b5743f81-6cf1-4f4b-aae3-4d964d9cfb77" location="4 12" name="CopyRateChange" factory-id="action-step">
		<start-script>import system, string
from ils.sfc.gateway.api import s88Set, s88Get, getDatabaseName, getProviderName, getChartLogger
from ils.common.util import getDate, formatDateTime
'''
Write the recipe data for the current cionfiguration to a log file
'''

def onStart(chart,block):
	provider = getProviderName(chart)
	database = getDatabaseName(chart)
	print "The database is: ", database
	log = getChartLogger(chart)
	log.tracef("Entering %s",block.get("name",""))

	# Read the reactor configuration
	paths = []
	paths.append("[%s]Site/RLA3/RX-CONFIGURATION-STRING" % (provider))
	paths.append("[%s]Configuration/SFC/CATOUT-PRINT-PATH" % (provider))
	paths.append("[%s]Configuration/SFC/CATOUT-PRINT-FILE-NAME" % (provider))
	paths.append("[%s]Configuration/SFC/CATOUT-PRINTER" % (provider))
	values = system.tag.readAll(paths)
	print values
	
	qv = values[0]
	print "Rx Config: ", qv
	if not(qv.quality.isGood()):
		log.errorf("Unable to read the reactor configuration in %s.", chart.get("name",""))
		return

	rxConfig = qv.value  
	log.tracef("  the reactor configuration is %s.", rxConfig)

	header = "%s CATOUT ON %s" % (string.upper(rxConfig),formatDateTime(getDate(database))) 

	qv = system.tag.read("[%s]Site/RLA3/RX-CONFIGURATION-STRING" % (provider))
	path = values[1].value
	fileName = values[2].value
	printer = values[3].value
	
	# Save the report to the event directory
	reportDictionary = {"RxConfig":rxConfig, "Header": header}
	actionDictionary = {"path":path, "fileName": fileName, "format": "pdf"}
	system.report.executeAndDistribute("Rate Change Data", "XOM", reportDictionary, "save", actionDictionary)
 
 	# Print the report
 	actionDictionary = {"primaryPrinterName": printer}
 	system.report.executeAndDistribute("Rate Change Data", "XOM", reportDictionary, "print", actionDictionary)
 
	log.tracef("   Done")</start-script>
		<associated-data>{}</associated-data>
	</step>
	<step id="bd4187c0-762b-11d9-a86f-006008c66680" location="6 13" name="S88Callback_13736" factory-id="action-step">
		<start-script># Copyright 2016 ILS Automation. All rights reserved.

'''
 Count all of the errors from the download blocks and store the sum in the operation. 
'''
from com.inductiveautomation.ignition.common.util import LogUtil
from ils.sfc.gateway.util import getFullChartPath
from ils.vistalon import util
from com.inductiveautomation.ignition.common.util import LoggerEx
from com.ils.sfc.python import UnitProcedure
from ils.constants.enumerations import S88State
from ils.sfc.gateway import api
from ils.constants.enumerations import S88Scope
def onStart(chart,block):
   log = LogUtil.getLogger(getFullChartPath(chart))
   log.tracef("In %s with %s, a %s. . .",chart.get("name",""),block.get("name",""),"step")
   block["state"]=str(S88State.RUNNING)

   operation = UnitProcedure.getSuperior(block)
   list = {}
   util.getInferiorInstances(chart,operation,"s88-write-outputs-task",list)
   totalWriteErrors = 0
   for outputBlock in list:
      totalWriteErrors = totalWriteErrors + outputblock.get("downloadErrorCounter","")
      if debugMode:
         blockName = util.getG2Name(outputBlock)
         log.infof("Counting download errors for %s = %s",str(blockName),outputblock.get("downloadErrorCounter",""))


   pass;  # Delete is not necessary in python
   #  Now store the total number of errors in the superior operation. 
   api.s88SetData(chart,block,"total-download-errors.val",totalWriteErrors,str(S88Scope.SUPERIOR))
   log.tracef("%s has completed!",block.get("name",""))</start-script>
		<associated-data>{}</associated-data>
	</step>
	<step id="0eed16bb-96fe-11d9-b116-00065b88c6c2" location="3 16" name="LogNormalCatout" factory-id="action-step">
		<start-script>'''
    Write a message to the operator logbook that about the operation based 
    on the description of the block and grade number. 
'''

import system
from ils.sfc.gateway.api import s88Set, s88Get, getDatabaseName
from ils.common.operatorLogbook import insertForPost
from ils.sfc.common.constants import LOCAL_SCOPE, SUPERIOR_SCOPE, PHASE_SCOPE, OPERATION_SCOPE, GLOBAL_SCOPE

def onStart(chart,block):
	log = system.util.getLogger(chart.chartPath)
	log.tracef("Entering %s",block.get("name",""))

	# Write logbook message to the logbook using description of block. 
	post = "XO1RLA3"
	db = getDatabaseName(chart)
	grade=s88Get(chart, block, "grade.value", GLOBAL_SCOPE)
	txt = "The catout sequence has completed NORMALLY for grade %s." % (str(grade))	
	insertForPost(post, txt, db)

	log.tracef("Leaving %s as complete!",block.get("name",""))</start-script>
		<associated-data>{}</associated-data>
	</step>
	<step id="4d49e743-96fe-11d9-b116-00065b88c6c2" location="5 16" name="LogErrorCatout" factory-id="action-step">
		<start-script>'''
Write a message to the operator logbook that CATOUT has completed with ERRORS. 
'''
import system
from ils.sfc.gateway.api import s88Set, s88Get, getDatabaseName
from ils.common.operatorLogbook import insertForPost
from ils.sfc.common.constants import LOCAL_SCOPE, SUPERIOR_SCOPE, PHASE_SCOPE, OPERATION_SCOPE, GLOBAL_SCOPE

def onStart(chart,block):
	log = system.util.getLogger(chart.chartPath)
	log.tracef("Entering %s",block.get("name",""))

	# Write logbook message to the logbook using description of block. 
	post = "XO1RLA3"
	db = getDatabaseName(chart)
	grade=s88Get(chart, block, "grade.value", GLOBAL_SCOPE)
	txt = "The catout sequence has completed with ERRORS for grade %s." % (str(grade))	
	insertForPost(post, txt, db)

	log.tracef("Leaving %s as complete!",block.get("name",""))</start-script>
		<associated-data>{}</associated-data>
	</step>
	<step id="c9caa4f4-762b-11d9-a86f-006008c66680" location="3 17" name="NormalQMessage" factory-id="com.ils.queueMessageStep"><name>NormalQMessage</name><description></description><id>c9caa4f4-762b-11d9-a86f-006008c66680</id><message>The CATOUT sequence terminated NORMALLY for grade {global.grade.value}.</message><priority>Info</priority>		<associated-data>{}</associated-data>
	</step>
	<step id="fb6e5ac8-762b-11d9-a86f-006008c66680" location="5 17" name="ErrorQMessage" factory-id="com.ils.queueMessageStep"><name>ErrorQMessage</name><description></description><id>fb6e5ac8-762b-11d9-a86f-006008c66680</id><message>The CATOUT sequence terminated with {operation.total-download-errors.value} errors.</message><priority>Warning</priority>		<associated-data>{}</associated-data>
	</step>
	<step id="efa5eb82-90dc-11d9-b116-00065b88c6c2" location="3 18" name="NormalCPMessage" factory-id="com.ils.controlPanelMessageStep"><description></description><timeoutUnit>SEC</timeoutUnit><message>The CATOUT sequence has completed NORMALLY. Click the RESET button on the control panel.</message><priority>Info</priority><postToQueue>false</postToQueue><timeout>10.0</timeout><ackRequired>false</ackRequired><name>NormalCPMessage</name><id>efa5eb82-90dc-11d9-b116-00065b88c6c2</id>		<associated-data>{}</associated-data>
	</step>
	<step id="efa5eb87-90dc-11d9-b116-00065b88c6c2" location="5 18" name="ErrorCPMessage" factory-id="com.ils.controlPanelMessageStep"><description></description><timeoutUnit>SEC</timeoutUnit><message>The CATOUT sequence has completed with ERRORS. Review the catout messages for errors. Then, click the RESET button on the control panel.</message><priority>Info</priority><postToQueue>false</postToQueue><timeout>10.0</timeout><ackRequired>false</ackRequired><name>ErrorCPMessage</name><id>efa5eb87-90dc-11d9-b116-00065b88c6c2</id>		<associated-data>{}</associated-data>
	</step>
	<step id="18f94b85-85b4-11d9-a871-006008c66680" location="3 20" name="S88End_13745" factory-id="end-step">		<associated-data>{}</associated-data>
	</step>
	<transition id="bd4187c5-762b-11d9-a86f-006008c66680" location="3 15" timeout-enabled="true" timeout-delay="108000000" timeout-flag="S88-CONDITIONAL-TRANSITION-XXX-13732">{operation.total-download-errors.value} = "0"</transition>
	<transition id="c1c1d01a-7636-11d9-a86f-006008c66680" location="5 15" timeout-enabled="true" timeout-delay="108000000" timeout-flag="S88-CONDITIONAL-TRANSITION-XXX-13740">{operation.total-download-errors.value} != "0"</transition>
	<parallel id="25d246f0-6b43-11d9-a9ad-00022dc3c8fd" location="1 5" size="7 6" enable-cancel-condition="true" cancel-condition="{operation.catout-download-complete.value}">
		<step id="8273d6d1-b1a0-48e0-80b8-07ca81c95317" location="0 0" name="Working" factory-id="com.ils.postDelayNotification"><buttonLabel>Working</buttonLabel><name>Working</name><description></description><scale>1.0</scale><id>8273d6d1-b1a0-48e0-80b8-07ca81c95317</id><position>topLeft</position><windowTitle>CATOUT in Progress</windowTitle><message>&lt;HTML&gt;A CATOUT is currently in progress.  This message &lt;br&gt;will disappear when the CATOUT has completed normally &lt;br&gt; (or has been aborted for unknown reasons).</message>				<associated-data>{}</associated-data>
		</step>
		<step id="5620e27a-753b-11d9-a86f-006008c66680" location="2 0" name="ShortDelay" factory-id="com.ils.timedDelayStep"><postNotification>false</postNotification><recipeLocation>superior</recipeLocation><tagPath></tagPath><description></description><scale>1.0</scale><windowTitle></windowTitle><message></message><buttonLabel></buttonLabel><delay>5.0</delay><name>ShortDelay</name><callback>G2</callback><id>5620e27a-753b-11d9-a86f-006008c66680</id><position>center</position><strategy>static</strategy><key>g2</key><delayUnit>SEC</delayUnit>				<associated-data>{}</associated-data>
		</step>
		<step id="682a64b3-f7bf-48f4-afa4-a86e630b16f2" location="2 2" name="StartCatOut" factory-id="enclosing-step" chart-path="VistalonUnitProcedure/PolymerizeEpdm/Catout/ImplementCo/StartCatout/StartCatout" execution-mode="RunUntilCompletion">				<associated-data>{"c3-ramp":{"lowLimit":0.0,"advice":"","description":"NA","label":"C3 Ramp","units":"True or False","type":"Truth-Value","help":"NA","dataId":"9b3492a8-222f-401a-bf76-05da61292e55","valueType":"Truth-Value","highLimit":0.0,"category":"Calculated Value","class":"Value","value":"true","key":"c3-ramp"}}</associated-data>
		</step>
		<step id="5372e430-6b43-11d9-a9ad-00022dc3c8fd" location="2 3" name="SetCompleteFlag" factory-id="com.ils.manualDataEntryStep"><manualDataConfig>{"rows":[{"key":"catout-download-complete.value","destination":"operation","prompt":"Signal to remove the UIL notification","units":"","defaultValue":true,"lowLimit":null,"highLimit":null}]}</manualDataConfig><description></description><scale>1.0</scale><timeoutUnit>SEC</timeoutUnit><windowTitle></windowTitle><timeout>-1.0</timeout><buttonLabel></buttonLabel><name>SetCompleteFlag</name><id>5372e430-6b43-11d9-a9ad-00022dc3c8fd</id><position>topCenter</position><window>S88-MANUAL-DATA-ENTRY-TASK-DIALOG</window><requireAllInputs>true</requireAllInputs><autoMode>automatic</autoMode>				<associated-data>{}</associated-data>
		</step>
		<step id="e9d6cc63-73df-438d-816c-201fdb760b9e" location="4 0" name="GUI" factory-id="com.ils.monitorDownloadStep"><timerKey>unit-procedure-start-time</timerKey><timerLocation>global</timerLocation><recipeLocation>operation</recipeLocation><timerSet>true</timerSet><description></description><scale>1.0</scale><windowTitle></windowTitle><buttonLabel></buttonLabel><timerClear>true</timerClear><monitorDownloadsConfig>{"rows":[{"key":"r1-c3-flow-spcl","labelAttribute":"names","units":""},{"key":"r2-c3-flow-spcl","labelAttribute":"names","units":""},{"key":"r1-c2-flow-sp","labelAttribute":"names","units":""},{"key":"r2-c2-flow-sp","labelAttribute":"names","units":""},{"key":"vcl4-flow-sp","labelAttribute":"names","units":""},{"key":"e204-c3-level-op","labelAttribute":"names","units":""},{"key":"e202-bypass-flow-op","labelAttribute":"names","units":""},{"key":"e205-bypass-flow-sp","labelAttribute":"names","units":""},{"key":"vocl3-flow-sp","labelAttribute":"names","units":""},{"key":"alkyl-flow-sp","labelAttribute":"names","units":""},{"key":"nh3-flow-sp","labelAttribute":"names","units":""},{"key":"etoh-flow-sp","labelAttribute":"names","units":""},{"key":"r1-c9-flow-sp","labelAttribute":"names","units":""},{"key":"r1-c9-recycle-flow-sp","labelAttribute":"names","units":""},{"key":"r2-c9-flow-sp","labelAttribute":"names","units":""},{"key":"h2-small-flow-sp","labelAttribute":"names","units":""},{"key":"h2-large-flow-op","labelAttribute":"names","units":""},{"key":"nh3-sweep-flow-sp","labelAttribute":"names","units":""},{"key":"oil-flow-op","labelAttribute":"names","units":""},{"key":"irg-flow-op","labelAttribute":"names","units":""},{"key":"d20-cast-flow-op","labelAttribute":"names","units":""},{"key":"d20a-cast-flow-op","labelAttribute":"names","units":""},{"key":"d20b-cast-flow-op","labelAttribute":"names","units":""}]}</monitorDownloadsConfig><name>GUI</name><id>e9d6cc63-73df-438d-816c-201fdb760b9e</id><position>center</position><window>SFC/MonitorDownloads</window>				<associated-data>{}</associated-data>
		</step>
		<step id="cc7175ae-1a5a-494e-bd5b-e06bcf22d692" location="4 1" name="Monitoring" factory-id="com.ils.pvMonitorStep"><timerKey>unit-procedure-start-time</timerKey><timerLocation>global</timerLocation><recipeLocation>operation</recipeLocation><timerSet>false</timerSet><description></description><dataLocation>SUPERIOR</dataLocation><pvMonitorConfig>{"rows":[{"enabled":true,"pvKey":"r1-c2-flow-sp","targetType":"Setpoint","targetNameIdOrValue":"r1-c2-flow-sp","strategy":"watch","limits":null,"download":null,"persistence":0.0,"consistency":0.0,"deadTime":0.0,"tolerance":0.0,"toleranceType":null,"status":"Enabled"},{"enabled":true,"pvKey":"r2-c2-flow-sp","targetType":"Setpoint","targetNameIdOrValue":"r2-c2-flow-sp","strategy":"watch","limits":null,"download":null,"persistence":0.0,"consistency":0.0,"deadTime":0.0,"tolerance":0.0,"toleranceType":null,"status":"Enabled"},{"enabled":true,"pvKey":"vcl4-flow-sp","targetType":"Setpoint","targetNameIdOrValue":"vcl4-flow-sp","strategy":"watch","limits":null,"download":null,"persistence":0.0,"consistency":0.0,"deadTime":0.0,"tolerance":0.0,"toleranceType":null,"status":"Enabled"},{"enabled":true,"pvKey":"e204-c3-level-op","targetType":"Setpoint","targetNameIdOrValue":"e204-c3-level-op","strategy":"watch","limits":null,"download":null,"persistence":0.0,"consistency":0.0,"deadTime":0.0,"tolerance":0.0,"toleranceType":null,"status":"Enabled"},{"enabled":true,"pvKey":"e202-bypass-flow-op","targetType":"Setpoint","targetNameIdOrValue":"e202-bypass-flow-op","strategy":"watch","limits":null,"download":null,"persistence":0.0,"consistency":0.0,"deadTime":0.0,"tolerance":0.0,"toleranceType":null,"status":"Enabled"},{"enabled":true,"pvKey":"e205-bypass-flow-sp","targetType":"Setpoint","targetNameIdOrValue":"e205-bypass-flow-sp","strategy":"watch","limits":null,"download":null,"persistence":0.0,"consistency":0.0,"deadTime":0.0,"tolerance":0.0,"toleranceType":null,"status":"Enabled"},{"enabled":true,"pvKey":"vocl3-flow-sp","targetType":"Setpoint","targetNameIdOrValue":"vocl3-flow-sp","strategy":"watch","limits":null,"download":null,"persistence":0.0,"consistency":0.0,"deadTime":0.0,"tolerance":0.0,"toleranceType":null,"status":"Enabled"},{"enabled":true,"pvKey":"alkyl-flow-sp","targetType":"Setpoint","targetNameIdOrValue":"alkyl-flow-sp","strategy":"watch","limits":null,"download":null,"persistence":0.0,"consistency":0.0,"deadTime":0.0,"tolerance":0.0,"toleranceType":null,"status":"Enabled"},{"enabled":true,"pvKey":"nh3-flow-sp","targetType":"Setpoint","targetNameIdOrValue":"nh3-flow-sp","strategy":"watch","limits":null,"download":null,"persistence":0.0,"consistency":0.0,"deadTime":0.0,"tolerance":0.0,"toleranceType":null,"status":"Enabled"},{"enabled":true,"pvKey":"etoh-flow-sp","targetType":"Setpoint","targetNameIdOrValue":"etoh-flow-sp","strategy":"watch","limits":null,"download":null,"persistence":0.0,"consistency":0.0,"deadTime":0.0,"tolerance":0.0,"toleranceType":null,"status":"Enabled"},{"enabled":true,"pvKey":"r1-c9-flow-sp","targetType":"Setpoint","targetNameIdOrValue":"r1-c9-flow-sp","strategy":"watch","limits":null,"download":null,"persistence":0.0,"consistency":0.0,"deadTime":0.0,"tolerance":0.0,"toleranceType":null,"status":"Enabled"},{"enabled":true,"pvKey":"r1-c9-recycle-flow-sp","targetType":"Setpoint","targetNameIdOrValue":"r1-c9-recycle-flow-sp","strategy":"watch","limits":null,"download":null,"persistence":0.0,"consistency":0.0,"deadTime":0.0,"tolerance":0.0,"toleranceType":null,"status":"Enabled"},{"enabled":true,"pvKey":"r2-c9-flow-sp","targetType":"Setpoint","targetNameIdOrValue":"r2-c9-flow-sp","strategy":"watch","limits":null,"download":null,"persistence":0.0,"consistency":0.0,"deadTime":0.0,"tolerance":0.0,"toleranceType":null,"status":"Enabled"},{"enabled":true,"pvKey":"h2-small-flow-sp","targetType":"Setpoint","targetNameIdOrValue":"h2-small-flow-sp","strategy":"watch","limits":null,"download":null,"persistence":0.0,"consistency":0.0,"deadTime":0.0,"tolerance":0.0,"toleranceType":null,"status":"Enabled"},{"enabled":true,"pvKey":"h2-large-flow-op","targetType":"Setpoint","targetNameIdOrValue":"h2-large-flow-op","strategy":"watch","limits":null,"download":null,"persistence":0.0,"consistency":0.0,"deadTime":0.0,"tolerance":0.0,"toleranceType":null,"status":"Enabled"},{"enabled":true,"pvKey":"r1-c3-flow-spcl","targetType":"Setpoint","targetNameIdOrValue":"r1-c3-flow-spcl","strategy":"watch","limits":null,"download":null,"persistence":0.0,"consistency":0.0,"deadTime":0.0,"tolerance":0.0,"toleranceType":null,"status":"Enabled"},{"enabled":true,"pvKey":"r2-c3-flow-spcl","targetType":"Setpoint","targetNameIdOrValue":"r2-c3-flow-spcl","strategy":"watch","limits":null,"download":null,"persistence":0.0,"consistency":0.0,"deadTime":0.0,"tolerance":0.0,"toleranceType":null,"status":"Enabled"}]}</pvMonitorConfig><name>Monitoring</name><id>cc7175ae-1a5a-494e-bd5b-e06bcf22d692</id><strategy>static</strategy><value>0.0</value><key>g2</key>				<associated-data>{}</associated-data>
		</step>
		<step id="ad6850f3-6288-42d7-9211-6e770e1eaf93" location="6 1" name="CRxDivert" factory-id="enclosing-step" chart-path="VistalonUnitProcedure/PolymerizeEpdm/Catout/ImplementCo/CRxDivertReminder" execution-mode="RunUntilCompletion">				<associated-data>{}</associated-data>
		</step>
		<transition id="33817cda-b845-4fd7-a99c-218024da92a3" location="2 1">{previous.workDone}</transition>
		<transition id="59e5b4d5-53b2-439e-836c-f59ebd10be69" location="4 2">{previous.workDone}</transition>
		<transition id="1db9e947-d70e-11e4-9591-00142223a71b" location="6 0" timeout-enabled="true" timeout-delay="30000" timeout-flag="S88-CONDITIONAL-TRANSITION-XXX-13717">{tag.Recipe/Local/C-RX-GRADE}</transition>
		<link id="b6d607b4-3ba7-4720-85e3-be09011b6564" location="0 1"><up/><down/></link>
		<link id="32230a0b-f362-49c3-8c7f-c0b5f23754bb" location="0 2"><up/><down/></link>
		<link id="b8fd4fcd-8ed6-4670-b419-1457275c83b4" location="0 3"><up/><down/></link>
		<link id="a66b4c65-c38a-4985-9ce6-39b24692c4d4" location="4 3"><up/><down/></link>
		<link id="c69552ce-2753-48bc-b2fc-eca5a4cb47b5" location="6 2"><up/><down/></link>
		<link id="a421acf4-8736-4647-b4bc-6aa8ecef1fab" location="6 3"><up/><down/></link>
	</parallel>
	<note id="b76dd586-f539-4819-9f57-a38e4dbbcc24" location="6 3" size="3 2">The Download GUI block used to have a local 
timer.  Maybe this didn't matter since all
writes are immediate, but I changed to use the 
global timer which was set earlier, but I'm
setting again.</note>
	<note id="81659b80-bb6b-4ad8-9ba2-ab68e2c4efae" location="8 1" size="2 1">Vetted 12/10/16</note>
	<note id="4af4f579-6019-441f-b2e1-38618c8d0e64" location="7 13" size="5 1">This is no longer needed, the write output block will 
update a global error counter</note>
	<link id="b9c0dda3-b807-41d3-b7b8-7cc8b0081a4a" location="4 13"><up/><down/></link>
	<link id="1de87c7a-f269-4e7c-bd12-91e9c7b787dd" location="3 14"><down/><right/></link>
	<link id="65c71372-a6ad-42d3-bef5-91c68b3a63f4" location="4 14"><up/><left/><right/></link>
	<link id="1d13fcd9-c950-4004-bccb-dcbea3866af0" location="5 14"><left/><down/></link>
	<link id="4355b792-2fb8-4007-8a4d-234577fed2e7" location="3 19"><up/><down/><right/></link>
	<link id="213a86db-c647-4750-a858-8b64da34bcfc" location="4 19"><up/><left/><right/></link>
	<link id="9041c633-af0f-451c-92bf-ec831d2ebe8d" location="5 19"><up/><left/><down/></link>

</sfc>
