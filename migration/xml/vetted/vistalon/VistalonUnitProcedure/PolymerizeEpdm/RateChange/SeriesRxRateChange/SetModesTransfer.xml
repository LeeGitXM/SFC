<?xml version="1.0" ?>
<sfc zoom="0.6761905" canvas="10 22" execution-mode="Callable" version="7.9.0 (b2016101208)" timestamp="Mon May 01 15:36:13 CDT 2017" hot-editable="false" persist-state="true">
	<oncancel>def onCancel(chart):
	"""
	This will run once if the chart is cancelled.

	Arguments:
		chart: A reference to the chart's scope.
	"""
	from xom.vistalon.sfc.polmerizeEpdm.rateChange.transfer import abortHandler
	abortHandler(chart,block)</oncancel>
	<onabort>def onAbort(chart):
	"""
	This will run once if the chart is aborted.
	The exception that caused the abort is
	available via chart.abortCause

	Arguments:
		chart: A reference to the chart's scope.
	"""
	from xom.vistalon.sfc.polmerizeEpdm.rateChange.transfer import abortHandler
	abortHandler(chart,block)</onabort>
	<step id="d8c54b3d-58d0-11dd-a699-00142223a71b" location="1 0" name="Begin" factory-id="begin-step">		<associated-data>{}</associated-data>
	</step>
	<step id="244f8637-5db7-11dd-a699-00142223a71b" location="1 1" name="SetRcDownloadCascadeStructures" factory-id="action-step">
		<start-script># Copyright 2016 ExxonMobil Corporation. All rights reserved.

'''
 Check H2 and N3 usage, (Current vs New) for a Rate Change and determine whether control structure should use "Ratio" or "% Change" as the handle for H2 or NH3 changes made via RC.  Set Flags in the Operation Recipe Data block to allow sequence transitions to interact appropriately with the required control structure.
'''
import system
from ils.sfc.common.constants import OPERATION_SCOPE,LOCAL_SCOPE
from finalDiagnosis import getBlock
from ScopeData import get
from ils.sfc.gateway.api import getChartLogger
from ils.sfc.gateway import api
def onStart(chart,block):
	log = system.util.getLogger(getChartLogger(chart))
	log.tracef("In %s with %s, a %s. . .",chart.get("name",""),block.get("name",""),"step")

	currentBlock = finalDiagnosis.getBlock(block,"em-s88-rate-change-current-data-callback")
	newBlock = finalDiagnosis.getBlock(block,"em-s88-rate-change-new-data-callback")
	#        Get the CURRENT and NEW H2 and NH3 Ratios from the Rate Change Sequence.
	currentH2ToVaRatio = ScopeData.get(currentBlock,"h2-to-va-ratio.val",LOCAL_SCOPE)
	currentNh3ToVaRatio = ScopeData.get(currentBlock,"nh3-to-va-ratio.val",LOCAL_SCOPE)
	newH2ToVaRatio = ScopeData.get(newBlock,"h2-to-va-ratio.val",LOCAL_SCOPE)
	newNh3ToVaRatio = ScopeData.get(newBlock,"nh3-to-va-ratio.val",LOCAL_SCOPE)
	log.tracef("In %s with OLD H2 Ratio = %s, NEW H2 Ratio = %s, OLD NH3 Ratio = %s  and NEW NH3 Ratio = %s.",chart.get("name",""),str(currentH2ToVaRatio),str(newH2ToVaRatio),str(currentNh3ToVaRatio),str(newNh3ToVaRatio))
	#      First deal with the H2 Controls Structure  -          IF we are introducing H2 (going from "0" to some "+value") or totally removing H2 (going from some "+value" to "0", then we need to use the "Ramping" structure, ELSE we need to be working with the "% Change" structure.
	if (((currentH2ToVaRatio == 0.0) and (newH2ToVaRatio &gt; 0.0)) or ((currentH2ToVaRatio &gt; 0.0) and (newH2ToVaRatio == 0.0))):
		h2CtlStructure = 0.0
	else:
		h2CtlStructure = 1.0

	log.tracef("In %s with H2 Ctl Structure set to %s.",chart.get("name",""),str(h2CtlStructure))
	#      Now deal with the NH3 Controls Structure in a similar manner  -          IF we are introducing NH3 (going from "0" to some "+value") or totally removing NH3 (going from some "+value" to "0", then we need to use the "Ramping" structure, ELSE we need to be working with the "% Change" structure.
	if (((currentNh3ToVaRatio == 0.0) and (newNh3ToVaRatio &gt; 0.0)) or ((currentNh3ToVaRatio &gt; 0.0) and (newNh3ToVaRatio == 0.0))):
		nh3CtlStructure = 0.0
	else:
		nh3CtlStructure = 1.0

	log.tracef("In %s with NH3 Ctl Structure set to %s.",chart.get("name",""),str(nh3CtlStructure))
	#       Write the H2 and NH3 Control Structure variables back to the OPERATION Recipe Data Block.
	api.s88SetData(chart,block,"rc-h2-ctl-structure.val",h2CtlStructure,OPERATION_SCOPE)
	api.s88SetData(chart,block,"rc-nh3-ctl-structure.val",nh3CtlStructure,OPERATION_SCOPE)
	log.tracef("%s has completed!",chart.get("name",""))
</start-script>
		<associated-data>{}</associated-data>
	</step>
	<step id="c2d7a243-5db8-11dd-a699-00142223a71b" location="1 4" name="SetupH2CtlbyRatio" factory-id="com.ils.manualDataEntryStep"><manualDataConfig>{"rows":[{"key":"RC-H2-VAN-RATIO-MODE.VALUE","destination":"operation","prompt":"Set H2/Vanadium Ratio Mode to AUTO","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null}]}</manualDataConfig><description></description><scale>1.0</scale><timeoutUnit>SEC</timeoutUnit><windowTitle></windowTitle><timeout>-1.0</timeout><buttonLabel></buttonLabel><name>SetupH2CtlbyRatio</name><id>c2d7a243-5db8-11dd-a699-00142223a71b</id><position>topCenter</position><window>S88-MANUAL-DATA-ENTRY-TASK-DIALOG</window><requireAllInputs>true</requireAllInputs><autoMode>automatic</autoMode>		<associated-data>{}</associated-data>
	</step>
	<step id="f104ed0f-5db9-11dd-a699-00142223a71b" location="2 4" name="SetupH2Ctlby%Change" factory-id="com.ils.manualDataEntryStep"><manualDataConfig>{"rows":[{"key":"RC-H2-VAN-RATIO-MODE.VALUE","destination":"operation","prompt":"Set H2/Vanadium Ratio Mode to CAS","units":"","defaultValue":"CAS","lowLimit":null,"highLimit":null}]}</manualDataConfig><description></description><scale>1.0</scale><timeoutUnit>SEC</timeoutUnit><windowTitle></windowTitle><timeout>-1.0</timeout><buttonLabel></buttonLabel><name>SetupH2Ctlby%Change</name><id>f104ed0f-5db9-11dd-a699-00142223a71b</id><position>topCenter</position><window>S88-MANUAL-DATA-ENTRY-TASK-DIALOG</window><requireAllInputs>true</requireAllInputs><autoMode>automatic</autoMode>		<associated-data>{}</associated-data>
	</step>
	<step id="5600a70d-5dba-11dd-a699-00142223a71b" location="1 9" name="SetupNh3CtlbyRatio" factory-id="com.ils.manualDataEntryStep"><manualDataConfig>{"rows":[{"key":"RC-NH3-VAN-RATIO-MODE.VALUE","destination":"operation","prompt":"Set NH3/Vanadium Ratio Mode to AUTO","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null}]}</manualDataConfig><description></description><scale>1.0</scale><timeoutUnit>SEC</timeoutUnit><windowTitle></windowTitle><timeout>-1.0</timeout><buttonLabel></buttonLabel><name>SetupNh3CtlbyRatio</name><id>5600a70d-5dba-11dd-a699-00142223a71b</id><position>topCenter</position><window>S88-MANUAL-DATA-ENTRY-TASK-DIALOG</window><requireAllInputs>true</requireAllInputs><autoMode>automatic</autoMode>		<associated-data>{}</associated-data>
	</step>
	<step id="703ce768-5dba-11dd-a699-00142223a71b" location="2 9" name="SetupNh3Ctlby%Change" factory-id="com.ils.manualDataEntryStep"><manualDataConfig>{"rows":[{"key":"RC-NH3-VAN-RATIO-MODE.VALUE","destination":"operation","prompt":"Set NH3/Vanadium Ratio Mode to CAS","units":"","defaultValue":"CAS","lowLimit":null,"highLimit":null}]}</manualDataConfig><description></description><scale>1.0</scale><timeoutUnit>SEC</timeoutUnit><windowTitle></windowTitle><timeout>-1.0</timeout><buttonLabel></buttonLabel><name>SetupNh3Ctlby%Change</name><id>703ce768-5dba-11dd-a699-00142223a71b</id><position>topCenter</position><window>S88-MANUAL-DATA-ENTRY-TASK-DIALOG</window><requireAllInputs>true</requireAllInputs><autoMode>automatic</autoMode>		<associated-data>{}</associated-data>
	</step>
	<step id="d8c54ab4-58d0-11dd-a699-00142223a71b" location="1 11" name="SetupMonomercontrollerModes" factory-id="com.ils.manualDataEntryStep"><manualDataConfig>{"rows":[{"key":"RC-MAIN-C3-C2-RATIO-MODE.VALUE","destination":"operation","prompt":"Set Main C3/C2 Ratio Mode to AUTO","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"RC-SEC-C3-C2-RATIO-MODE.VALUE","destination":"operation","prompt":"Set Sec C3/c2 Ratio Mode to AUTO","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"RC-MAIN-C9-C2-RATIO-MODE.VALUE","destination":"operation","prompt":"Set Main C9/C2 Ratio Mode to AUTO","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null},{"key":"RC-SEC-C9-C2-RATIO-MODE.VALUE","destination":"operation","prompt":"Set Sec C9/C2 Ratio Mode to AUTO","units":"","defaultValue":"AUTO","lowLimit":null,"highLimit":null}]}</manualDataConfig><description></description><scale>1.0</scale><timeoutUnit>SEC</timeoutUnit><windowTitle></windowTitle><timeout>-1.0</timeout><buttonLabel></buttonLabel><name>SetupMonomercontrollerModes</name><id>d8c54ab4-58d0-11dd-a699-00142223a71b</id><position>topCenter</position><window>S88-MANUAL-DATA-ENTRY-TASK-DIALOG</window><requireAllInputs>true</requireAllInputs><autoMode>automatic</autoMode>		<associated-data>{}</associated-data>
	</step>
	<step id="7e29c2bd-5dbb-11dd-a699-00142223a71b" location="1 12" name="WriteModesforRateChange" factory-id="com.ils.writeOutputStep"><globalErrorCountKey></globalErrorCountKey><timerKey>rc-timer</timerKey><timerLocation>operation</timerLocation><recipeLocation>operation</recipeLocation><timerSet>false</timerSet><description></description><globalErrorCountLocation>local</globalErrorCountLocation><verbose>true</verbose><name>WriteModesforRateChange</name><writeOutputConfig>{"rows":[{"key":"RC-MAIN-C3-C2-RATIO-MODE","confirmWrite":true},{"key":"RC-SEC-C3-C2-RATIO-MODE","confirmWrite":true},{"key":"RC-MAIN-C9-C2-RATIO-MODE","confirmWrite":true},{"key":"RC-SEC-C9-C2-RATIO-MODE","confirmWrite":true},{"key":"RC-H2-VAN-RATIO-MODE","confirmWrite":true},{"key":"RC-NH3-VAN-RATIO-MODE","confirmWrite":true}]}</writeOutputConfig><id>7e29c2bd-5dbb-11dd-a699-00142223a71b</id>		<associated-data>{}</associated-data>
	</step>
	<step id="d8c54ab9-58d0-11dd-a699-00142223a71b" location="1 14" name="TransferTrueMsg" factory-id="com.ils.controlPanelMessageStep"><description></description><timeoutUnit>SEC</timeoutUnit><message>Transfer of rate change setpoints to the setpoint download screen has been selected by the operator.</message><priority>Info</priority><postToQueue>false</postToQueue><timeout>10.0</timeout><ackRequired>false</ackRequired><name>TransferTrueMsg</name><id>d8c54ab9-58d0-11dd-a699-00142223a71b</id>		<associated-data>{}</associated-data>
	</step>
	<step id="d8c54b11-58d0-11dd-a699-00142223a71b" location="1 15" name="TransferData" factory-id="action-step">
		<start-script>def onStart(chart,block):
	from xom.vistalon.sfc.polmerizeEpdm.rateChange.transfer import transfer
	transfer(chart,block)</start-script>
		<associated-data>{}</associated-data>
	</step>
	<step id="d8c54ace-58d0-11dd-a699-00142223a71b" location="1 16" name="CheckForspWorkspace" factory-id="enclosing-step" chart-path="VistalonUnitProcedure/PolymerizeEpdm/RateChange/CheckForSpWorkspace" execution-mode="RunUntilCompletion">		<associated-data>{}</associated-data>
	</step>
	<step id="d8c54ac3-58d0-11dd-a699-00142223a71b" location="1 17" name="ResetCtlrmodes" factory-id="com.ils.manualDataEntryStep"><manualDataConfig>{"rows":[{"key":"RC-MAIN-C3-C2-RATIO-MODE.VALUE","destination":"operation","prompt":"Set Main C3/C2 Ratio Mode to CAS","units":"","defaultValue":"CAS","lowLimit":null,"highLimit":null},{"key":"RC-SEC-C3-C2-RATIO-MODE.VALUE","destination":"operation","prompt":"Set Sec C3/C2 Ratio Mode to CAS","units":"","defaultValue":"CAS","lowLimit":null,"highLimit":null},{"key":"RC-MAIN-C9-C2-RATIO-MODE.VALUE","destination":"operation","prompt":"Set Main C9/C2 Ratio Mode to CAS","units":"","defaultValue":"CAS","lowLimit":null,"highLimit":null},{"key":"RC-SEC-C9-C2-RATIO-MODE.VALUE","destination":"operation","prompt":"Set Sec C9/C2 Ratio Mode to CAS","units":"","defaultValue":"CAS","lowLimit":null,"highLimit":null},{"key":"RC-H2-VAN-RATIO-MODE.VALUE","destination":"operation","prompt":"Set H2/Vanadium Ratio Mode to CAS","units":"","defaultValue":"CAS","lowLimit":null,"highLimit":null},{"key":"RC-NH3-VAN-RATIO-MODE.VALUE","destination":"operation","prompt":"Set NH3/Vanadium Ratio Mode to CAS","units":"","defaultValue":"CAS","lowLimit":null,"highLimit":null}]}</manualDataConfig><description></description><scale>1.0</scale><timeoutUnit>SEC</timeoutUnit><windowTitle></windowTitle><timeout>-1.0</timeout><buttonLabel></buttonLabel><name>ResetCtlrmodes</name><id>d8c54ac3-58d0-11dd-a699-00142223a71b</id><position>topCenter</position><window>S88-MANUAL-DATA-ENTRY-TASK-DIALOG</window><requireAllInputs>true</requireAllInputs><autoMode>automatic</autoMode>		<associated-data>{}</associated-data>
	</step>
	<step id="d8c54ac8-58d0-11dd-a699-00142223a71b" location="1 18" name="ReWritectlrModes" factory-id="com.ils.writeOutputStep"><globalErrorCountKey></globalErrorCountKey><timerKey>rc-timer</timerKey><timerLocation>operation</timerLocation><recipeLocation>operation</recipeLocation><timerSet>false</timerSet><description></description><globalErrorCountLocation>local</globalErrorCountLocation><verbose>true</verbose><name>ReWritectlrModes</name><writeOutputConfig>{"rows":[{"key":"RC-MAIN-C3-C2-RATIO-MODE","confirmWrite":true},{"key":"RC-SEC-C3-C2-RATIO-MODE","confirmWrite":true},{"key":"RC-MAIN-C9-C2-RATIO-MODE","confirmWrite":true},{"key":"RC-SEC-C9-C2-RATIO-MODE","confirmWrite":true},{"key":"RC-H2-VAN-RATIO-MODE","confirmWrite":true},{"key":"RC-NH3-VAN-RATIO-MODE","confirmWrite":true}]}</writeOutputConfig><id>d8c54ac8-58d0-11dd-a699-00142223a71b</id>		<associated-data>{}</associated-data>
	</step>
	<step id="d8c54b15-58d0-11dd-a699-00142223a71b" location="1 20" name="End" factory-id="end-step">		<associated-data>{}</associated-data>
	</step>
	<transition id="d908a649-5db7-11dd-a699-00142223a71b" location="1 3" timeout-enabled="true" timeout-delay="30000" timeout-flag="RC H2 CtlBy Ratio">{operation.rc-h2-ctl-structure.value} &lt;= "0.5"</transition>
	<transition id="9ca3b427-5db8-11dd-a699-00142223a71b" location="2 3" timeout-enabled="true" timeout-delay="30000" timeout-flag="RC H2 CtlBy % Change">{operation.rc-h2-ctl-structure.value} &gt; "0.5"</transition>
	<transition id="20c6882e-5db9-11dd-a699-00142223a71b" location="1 8" timeout-enabled="true" timeout-delay="30000" timeout-flag="RC NH3 CtlBy Ratio">{operation.rc-nh3-ctl-structure.value} &lt;= "0.5"</transition>
	<transition id="20c68829-5db9-11dd-a699-00142223a71b" location="2 8" timeout-enabled="true" timeout-delay="30000" timeout-flag="RC NH3 CtlBy % Change">{operation.rc-nh3-ctl-structure.value} &gt; "0.5"</transition>
	<transition id="cc0d03cd-47b3-491c-ae49-2a4da44049b5" location="1 13">{previous.workDone}</transition>
	<transition id="0ff7ee4c-30f9-4b95-a122-233f19769123" location="1 19">{previous.workDone}</transition>
	<note id="f1847867-9d1e-4ebb-930f-4c8ab3d84daa" location="3 0" size="3 1">This chart has an Abort handler.</note>
	<link id="2fd74497-1d7f-4e80-966c-d0c6fac6608e" location="1 2"><up/><down/><right/></link>
	<link id="980d5cfa-49eb-4daf-9b06-e4b426863d1d" location="2 2"><up/><left/><down/></link>
	<link id="aab7fc73-36dc-4514-ac00-332a7c682052" location="1 5"><up/><down/><right/></link>
	<link id="ec4d1e54-3800-4059-9565-9acf8ccdcd8c" location="2 5"><up/><left/><down/></link>
	<link id="3788f8ee-8486-40bc-b101-db232df15a12" location="1 6"><up/><down/></link>
	<link id="0b07d336-0776-424b-b450-8c44c0ed7a5e" location="1 7"><up/><down/><right/></link>
	<link id="8ccd99ae-001c-4dcf-9c63-b8112d9577df" location="2 7"><up/><left/><down/></link>
	<link id="d5ccbec2-0d09-4401-8385-0888cc5b13fe" location="1 10"><up/><down/><right/></link>
	<link id="30616da1-2205-4441-87c3-303e102106ee" location="2 10"><up/><left/><down/></link>

</sfc>
